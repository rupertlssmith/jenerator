<project default="dist"
         xmlns:t="jelly:threads"
         xmlns:j="jelly:core"
         xmlns:m="jelly:maven"
         xmlns:javasource="javasource"
         xmlns:ant="jelly:ant">

  <goal name="dist">
    <attainGoal name="jboss:install"/>
    <attainGoal name="transform_templates"/>
    <attainGoal name="ear:ear"/>
    <attainGoal name="cactustests"/>
  </goal>

  <!-- Transforms all the .template files. -->
  <goal name="transform_templates">

    <!-- Tranform the template files into files ready for deployment. -->
    <echo>Transforming .template files...</echo>
     
     <!-- Copy the templates into xml files substituting in the required properties. -->    
     <copy todir="src/application" overwrite="true">
       <fileset dir="src/application">
         <include name="*.template"/>
       </fileset>
       <mapper type="glob" from="*.template" to="*.xml"/>
       <filterset>
         <filter token="EAR_FILE" value="${maven.final.name}.ear"/>
       </filterset>
       <filterset>
         <filter token="INDEX_RA_VERSION" value="0.3"/>
       </filterset>
     </copy>
  </goal>

  <goal name="cactustests">

    <!-- Ensures it is deployed before the cactus tests are run. -->
    <attainGoal name="cactus:cactifyear"/>
    <attainGoal name="jboss:install"/>
    <attainGoal name="jboss:start"/>

    <echo>Waiting for jboss to start...</echo>
    <waitfor maxwait="3" maxwaitunit="minute" checkevery="500">
      <http url="http://localhost:8010/"/>
    </waitfor>

    <attainGoal name="jboss:deploy-named-ear"/>

    <echo>Waiting for .ear file to be deployed...</echo>
    <waitfor maxwait="3" maxwaitunit="minute" checkevery="500">
      <http url="http://localhost:8010/catalogue-ejb-test/"/>
    </waitfor>

    <!--
     Run all the cactus tests. This is done in a seperate thread so that test failures do not terminate the build
     immediately as the appserver has still to be shut down.
     -->
    <t:thread var="testthread">
     <attainGoal name="cactus:test"/>

     <!-- If it gets as far as this without failing then the tests have passed. -->
     <property name="test.success" value="true"/>
    </t:thread>
    
    <!-- Wait for the test thread to finish. -->
    <t:join thread="${testthread}"/>

    <!-- Remove the deployed app and shutdown tomcat to clean up after tests are run. -->
    <attainGoal name="jboss:undeploy-named-ear"/>
    <attainGoal name="jboss:stop"/>

    <!-- Check if the tests passed or not. -->
    <echo>test.success = ${test.success}</echo>

    <j:if test="${context.getVariable('test.success') != 'true'}">
      <fail>There were cactus test failures.</fail>
    </j:if>

  </goal>

</project>